<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    <title>Prototyping Page</title>

    <!-- This STYLE element content can be moved to sidebar/sidebar.css -->
    <style>
      /* 
      Note this will not be needed in the extension sidebar 
      */
      aside {
        width: 20%;
        float: left;
        border: 1px solid darkgray;
      }

      .class-selector {
        border: 4px solid white;
        display: block;
        width: 100%;
        margin: 1em 0 1em;
        padding: 0.5em;
      }

      .class-selector.selected {
        border: 4px solid black;
      }
    </style>

    <!-- This is just basic styling for the test content -->
    <style>
      main {
        float: left;
        width: 70%;
        padding: 1em;
        border: 1px solid darkgray;
      }

      div {
        padding: 1em;
      }

      .nav li {
        display: inline-block;
        list-style-type: none;
      }

      .footer {
        background: lightgrey;
      }

      .footer div {
        display: inline-block;
      }
    </style>
  </head>

  <body>
    <!-- Stubbing out possible sidebar layout for extension within an ASIDE element -->
    <aside id="sidebar">
      <div>
        <input type="checkbox" id="taggingActive" />
        <label for="taggingActive">Activate tagging</label>
        <button class="class-selector" style="background-color:aqua" data-class="header">header</button>
        <button class="class-selector" style="background-color:cadetblue" data-class="header-nav">header-nav</button>
        <button class="class-selector" style="background-color:burlywood" data-class="content">content</button>
        <button class="class-selector" style="background-color:lightgreen" data-class="content-card">content-card</button>
        <button class="class-selector" style="background-color:khaki" data-class="sidebar">sidebar</button>
        <button class="class-selector" style="background-color:yellow" data-class="sidebar-nav">sidebar-nav</button>
        <button class="class-selector" style="background-color:darksalmon" data-class="advertisement">advertisement</button>
        <button class="class-selector" style="background-color:mediumorchid" data-class="footer">footer</button>
        <button class="class-selector" style="background-color:lightyellow" data-class="footer-nav">footer-nav</button>
        <button id="reset" disabled=true>Reset</button>
      </div>
    </aside>

    <!-- Main page test content-->
    <main>
      <div class="header">
        <div class="nav">
          <ul>
            <li><a href="#Home">Home</a></li>
            <li><a href="#About">About</a></li>
            <li><a href="#Contact">Contact</a></li>
          </ul>
        </div>
      </div>
  
      <div class="content">
        <article>
          <h1>Content title</h1>
          <p>Para One</p>
          <p>Para Two</p>
          <p>Para Three</p>
        </article>
      </div>
  
      <div class="footer">
        <div class="nav">
          <ul>
            <li><a href="#Privacy">Privacy</a></li>
            <li><a href="#TOS">TOS</a></li>
            <li><a href="#Social">Social</a></li>
          </ul>
        </div>
      </div>
    </main>

    <!-- This SCRIPT element content can be moved to sidebar/sidebar.js and/or into a content script as needed to function cross-window -->
    <script lang="javascript">
      // Define and init application state
      var state = {
        curClass: null,
        curElement: null,
        taggingToggle: document.getElementById('taggingActive'),
        resetButton: document.getElementById('reset'),
        tagClasses: {},
      }

      // Test if we can tag the currently active element
      function taggableElement(e) {
        // NOTE the sidebar tets goes away opnce moved into an extension
        sidebar = document.getElementById('sidebar');
        target = e.target;
        casedTagName = target.tagName.toLowerCase();
        if (state.taggingToggle.checked && 
            state.selectedClassButton !== null && 
            casedTagName !== 'html' && target !== casedTagName !== 'body' && 
            sidebar !== target &&
            !sidebar.contains(target)) return true;
        return false;
      }

      // Update the document element backgrounds based on mouseover update
      function updateBackgrounds(target) {
        prevElement = state.curElement;
        state.curElement = target;

        if (prevElement !== null) {
          if (!prevElement.dataset.heaTaggedClass) {
            prevColor = prevElement.dataset.heaPrevBgcolor;
          }
          else {
            prevColor = prevElement.dataset.heaTaggedClassBgcolor;
          }
          prevElement.style.backgroundColor = prevColor;
        }
        if (state.curElement !== null) {
          tagClass = state.curClass;
          selectedClassColor = state.tagClasses[tagClass];
          state.curElement.dataset.heaPrevBgcolor = state.curElement.style.backgroundColor;
          state.curElement.style.backgroundColor = selectedClassColor;
        }
      }

      // Tag element with currently selected data class and do something with it
      function addTaggedElement(el) {
        tagClass = state.curClass;
        el.dataset.heaTaggedClass = tagClass;
        el.dataset.heaTaggedClassBgcolor = state.tagClasses[tagClass];
        data = {
          docInfo: document, 
          html: document.getRootNode().children[0].outerHTML,
        };
        console.log('tagged', tagClass);
        //console.log(JSON.stringify(data));
      }

      // Register click handler for each tag class button in sidebar
      document.querySelectorAll('.class-selector').forEach(item => {
        state.tagClasses[item.dataset.class] = item.style.backgroundColor;
        item.addEventListener('click', function(e) {
          state.curClass = e.currentTarget.dataset.class;
          document.querySelectorAll('.class-selector').forEach(item => {
            item.classList.remove('selected');
          })
          e.target.classList.toggle('selected');
        })
      });

      // Add mouseover handler for taggable page elements
      document.addEventListener('mouseover', function(e) {
        if (taggableElement(e)) {
          updateBackgrounds(e.target);
        }
        else {
          updateBackgrounds(null);
        }
      });

      // Add click handler for taggable page elements
      document.addEventListener('click', function(e) {
        if (taggableElement(e)) {
          taggedElement = e.target;
          addTaggedElement(taggedElement);
          e.preventDefault();
        }
      });

      state.resetButton.addEventListener('click', function(e) {
        if (state.taggingToggle.checked) {
          Array.from(document.all).forEach(item => {
            if (item.dataset.heaPrevBgcolor !== null) {
              item.style.backgroundColor = item.dataset.heaPrevBgcolor;
            }
            delete item.dataset.heaPrevBgcolor;
            delete item.dataset.heaTaggedClass;
            delete item.dataset.heaTaggedClassBgcolor;
          });
        }
      });

      state.taggingToggle.addEventListener('click', function(e) {
        state.resetButton.disabled = state.taggingToggle.checked ? false : true;
      });
    </script>

  </body>
</html>